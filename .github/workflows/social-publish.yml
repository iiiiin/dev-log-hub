name: Publish Post

on:
  push:
    branches:
      - main
    paths:
      - 'social/**.json'   # SNS ë°°í¬ìš© íŠ¸ë¦¬ê±°
      - 'public/**.md'     # Qiita ë°°í¬ìš© íŠ¸ë¦¬ê±°

jobs:
  # ---------------------------------------------------
  # 1. Qiita ë°°í¬ Job (CLI ì‚¬ìš© + ID ë™ê¸°í™”)
  # ---------------------------------------------------
  publish-qiita:
    # public í´ë”ì— ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: contains(github.event.head_commit.modified, 'public/') || contains(github.event.head_commit.added, 'public/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Git ì´ë ¥ì„ ìœ„í•´ í•„ìˆ˜ (ì»¤ë°‹ì„ ë‹¤ì‹œ í•´ì•¼ í•˜ë¯€ë¡œ)

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci # package-lock.json ê¸°ë°˜ìœ¼ë¡œ ë¹ ë¥´ê³  ì•ˆì „í•˜ê²Œ ì„¤ì¹˜

      - name: Publish to Qiita
        env:
          QIITA_TOKEN: ${{ secrets.QIITA_TOKEN }} # ðŸ”‘ Secret í•„ìš”!
        run: npx qiita publish --all

      - name: Commit Qiita ID back to repo
        # ë°°í¬ í›„ Qiitaê°€ íŒŒì¼ì— 'id: xxxx'ë¥¼ ì ì–´ì¤ë‹ˆë‹¤. ì´ê±¸ ë‹¤ì‹œ ì €ìž¥í•´ì•¼ í•©ë‹ˆë‹¤.
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add public/
          # ë³€ê²½ì‚¬í•­(ID ìƒì„±ë¨)ì´ ìžˆì„ ë•Œë§Œ ì»¤ë°‹
          git diff --staged --quiet || git commit -m "chore: update qiita id [skip ci]"
          git push

  # ---------------------------------------------------
  # 2. SNS ë°°í¬ Job (n8n Webhook í˜¸ì¶œ)
  # ---------------------------------------------------
  notify-n8n:
    # social í´ë”ì— JSON íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: contains(github.event.head_commit.modified, 'social/') || contains(github.event.head_commit.added, 'social/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get changed SNS file
        id: file
        run: |
          # ê°€ìž¥ ìµœê·¼ì— ìˆ˜ì •ëœ social í´ë”ì˜ json íŒŒì¼ì„ ì°¾ìŒ
          FILE=$(ls -t social/*.json | head -n 1)
          echo "Found file: $FILE"
          echo "filepath=$FILE" >> $GITHUB_OUTPUT

      - name: Read JSON content
        id: json
        run: |
          # JSON ë‚´ìš©ì„ í•œ ì¤„ë¡œ ì••ì¶•í•´ì„œ ì½ìŒ
          CONTENT=$(cat ${{ steps.file.outputs.filepath }} | jq -c .)
          echo "content=$CONTENT" >> $GITHUB_OUTPUT

      - name: Send to n8n
        uses: distributhor/workflow-webhook@v3
        with:
          webhook_url: ${{ secrets.N8N_PUBLISH_URL }} # ðŸ”‘ Secret í•„ìš”!
          data: ${{ steps.json.outputs.content }}